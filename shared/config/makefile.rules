#
# Copyright (C) 2014-2019 Jan Fiedor <fiedorjan@centrum.cz>
#
# This file is part of ANaConDA.
#
# ANaConDA is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# ANaConDA is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with ANaConDA. If not, see <http://www.gnu.org/licenses/>.
#

#
# General rules file for all parts of ANaConDA.
#
# Contains definitions of rules necessary to build the ANaConDA framework, its
#   wrappers and analysers.
#
# File:      makefile.rules
# Author:    Jan Fiedor (fiedorjan@centrum.cz)
# Date:      Created 2014-10-03
# Date:      Last Update 2019-02-11
# Version:   0.8.1
#

# Builds a release version of the target
all: release

# Builds a debug version of the target
debug: pre-build-debug build-target post-build

# Builds a release version of the target
release: pre-build-release build-target post-build

# Prepares the environment for building a debug version of the target
pre-build-debug: pre-build
	$(eval CMAKE_FLAGS := $(CMAKE_FLAGS) -DCMAKE_BUILD_TYPE=Debug -DDEBUG=1)

# Prepares the environment for building a release version of the target
pre-build-release: pre-build
	$(eval CMAKE_FLAGS := $(CMAKE_FLAGS) -DCMAKE_BUILD_TYPE=Release -DRELEASE=1)

# Prepares the environment for building the target
pre-build::
	mkdir -p $(BUILD_DIR)

# Builds the target
build-target:
	cd $(BUILD_DIR) && $(CMAKE) $(CMAKE_FLAGS) $(CMAKE_SOURCE_DIR)
	$(MAKE) -C $(BUILD_DIR)

# Executes additional actions after building the target
post-build::

# Installs the target
install:
ifneq ("$(wildcard $(BUILD_DIR)/Makefile)", "")
	$(MAKE) -C $(BUILD_DIR) install
endif

# Uninstalls the target
uninstall:
ifneq ("$(wildcard $(BUILD_DIR)/install_manifest.txt)", "")
	@$(CMAKE) -E cmake_echo_color --cyan "Uninstall the project..."
	@for file in `cat $(BUILD_DIR)/install_manifest.txt | sed -e "s/\r//"`; do \
	  echo "-- Uninstalling: $$file"; \
	  rm -f $$file; \
	  if test -d `dirname $$file`; then \
	    rmdir -p --ignore-fail-on-non-empty `dirname $$file`; \
	  fi; \
	done
	@rm -f $(BUILD_DIR)/install_manifest.txt
endif

# Builds the programs needed to test the target
build-tests:
ifneq ("$(wildcard $(BUILD_DIR)/Makefile)", "")
	$(MAKE) -C $(BUILD_DIR) build-tests
endif

# Tests the target
test:
ifneq ("$(wildcard $(BUILD_DIR)/Makefile)", "")
	$(MAKE) -C $(BUILD_DIR) test
endif

# Deletes the programs needed to test the target
clean-tests:
ifneq ("$(wildcard $(BUILD_DIR)/CTestTestfile.cmake)", "")
	$(MAKE) -C $(BUILD_DIR) clean-tests
endif

# Deletes all files created by Makefiles generated by CMake
clean::
ifneq ("$(wildcard $(BUILD_DIR)/Makefile)", "")
	$(MAKE) -C $(BUILD_DIR) clean
endif

# Deletes all files created by both CMake and Makefiles generated by it
distclean: clean clean-tests
ifneq ("$(wildcard $(BUILD_DIR))", "")
	rm -rf $(BUILD_DIR)/CMakeFiles $(BUILD_DIR)/CMakeCache.txt \
	  $(BUILD_DIR)/CTestTestfile.cmake $(BUILD_DIR)/Makefile \
	  $(BUILD_DIR)/cmake_install.cmake $(BUILD_DIR)/install_manifest.txt \
	  $(BUILD_DIR)/scanner.info $(BUILD_DIR)/*.exp
	rmdir -p --ignore-fail-on-non-empty $(abspath $(BUILD_DIR))
endif

# End of file makefile.rules
